<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      display: flex;
      height: 100vh;
      background: #f8fafc;
      color: #111827;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #1e293b, #0f172a);
      color: white;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar h2 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 28px;
      text-align: center;
      color: #f1f5f9;
    }
    .nav-btn {
      padding: 12px 14px;
      margin-bottom: 12px;
      background: transparent;
      border: none;
      color: #e2e8f0;
      text-align: left;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: background 0.3s, transform 0.15s;
    }
    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(4px);
    }
    .nav-btn.active {
      background: #2563eb;
      color: white;
    }
    .logout-btn {
      margin-top: auto;
      background: #ef4444;
      color: white;
      font-weight: 600;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      width: 100%;
    }
    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.02);
    }

    /* Main */
    .main {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }
    h3 {
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      border-radius: 16px;
      padding: 24px;
      color: white;
      text-align: center;
      font-size: 15px;
      font-weight: 500;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }
    .stat-card span {
      display: block;
      font-size: 32px;
      font-weight: 700;
      margin-top: 8px;
    }
    .stat-card::after {
      content: "";
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(255,255,255,0.25), transparent 70%);
      transform: rotate(25deg);
    }
    #nutritionCount { background: linear-gradient(135deg, #34d399, #059669); }
    #workoutCount { background: linear-gradient(135deg, #60a5fa, #2563eb); }
    #coachingCount { background: linear-gradient(135deg, #f97316, #ea580c); }
    #contactsCount { background: linear-gradient(135deg, #f43f5e, #be123c); }
    .stat-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 12px 28px rgba(0,0,0,0.18);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
    }
    th {
      padding: 16px;
      background: #f1f5f9;
      font-weight: 600;
      font-size: 14px;
      color: #334155;
      text-align: left;
    }
    td {
      padding: 16px;
      font-size: 14px;
      color: #475569;
      border-bottom: 1px solid #f1f5f9;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: #f9fafb; cursor: pointer; }

    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 100;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 14px;
      width: 480px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      animation: fadeUp 0.3s ease;
    }
    @keyframes fadeUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-content h3 { margin-top: 0; margin-bottom: 16px; font-size: 18px; color: #1e293b; font-weight: 600; }
    .modal-content p { font-size: 14px; padding: 6px 0; border-bottom: 1px solid #f1f5f9; color: #475569; }
    .modal-content p:last-child { border-bottom: none; }
    .close-btn {
      background: #2563eb;
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      margin-top: 18px;
      width: 100%;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .close-btn:hover { background: #1d4ed8; }

    /* Permissions Buttons */
    .approve-btn, .deny-btn {
      padding: 4px 8px;
      margin-right: 4px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .approve-btn { background: #34d399; color: white; }
    .deny-btn { background: #f43f5e; color: white; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Dashboard</h2>
    <button class="nav-btn active" data-col="personal_nutrition_plan" data-type="normal">ü•ó Personal Nutrition Plan</button>
    <button class="nav-btn" data-col="personal_workout_plan" data-type="normal">üèãÔ∏è Personal Workout Plan</button>
    <button class="nav-btn" data-col="ultimate_personal_coaching" data-type="normal">üî• Ultimate Personal Coaching</button>
    <button class="nav-btn" data-col="contacts" data-type="contact">üì© Messages</button>
    <button class="nav-btn" data-col="permissions" data-type="permissions">üõ†Ô∏è Permissions</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card" id="nutritionCount">ü•óNutrition Plan: 0</div>
      <div class="stat-card" id="workoutCount">üèãÔ∏èPersonal Workouts: 0</div>
      <div class="stat-card" id="coachingCount">üî•Ultimate Coaching: 0</div>
      <div class="stat-card" id="contactsCount">üì© Messages: 0</div>
    </div>

    <h3 id="collectionTitle">ü•ó Personal Nutrition Plan</h3>
    <table>
      <thead id="tableHead"></thead>
      <tbody id="dataTable">
        <tr><td>Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3>User Details</h3>
      <div id="modalBody"></div>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- JS -->
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1705Xy74qwXt8aOgvZGBIYs8uMU6u3js",
  authDomain: "ironnrootfitness-5156e.firebaseapp.com",
  projectId: "ironnrootfitness-5156e",
  storageBucket: "ironnrootfitness-5156e.firebasestorage.app",
  messagingSenderId: "508351386284",
  appId: "1:508351386284:web:289185a2ff7a08b8ef0509",
  measurementId: "G-S6235MZEPC"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

const collectionTitle = document.getElementById("collectionTitle");
const dataTable = document.getElementById("dataTable");
const tableHead = document.getElementById("tableHead");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");

const nutritionCount = document.getElementById("nutritionCount");
const workoutCount = document.getElementById("workoutCount");
const coachingCount = document.getElementById("coachingCount");
const contactsCount = document.getElementById("contactsCount");

async function loadData(colName, title, type) {
  collectionTitle.textContent = title;
  dataTable.innerHTML = `<tr><td>Loading...</td></tr>`;

  // Set table headers
  if(type==="contact"){
    tableHead.innerHTML = `<tr><th>Name</th><th>Phone</th><th>Email</th></tr>`;
  } else if(type==="permissions"){
    tableHead.innerHTML = `<tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr>`;
  } else {
    tableHead.innerHTML = `<tr><th>Name</th><th>Gender</th><th>Age</th><th>Phone</th><th>Email</th><th>Amount Paid</th><th>Status</th></tr>`;
  }

  let snapshot;
  if(type==="permissions"){
    // Fetch only users where isApproved == false
    const usersRef = collection(db,"users");
    const q = query(usersRef, where("isApproved","==",false));
    snapshot = await getDocs(q);
  } else {
    snapshot = await getDocs(collection(db,colName));
  }

  dataTable.innerHTML = "";
  updateCount(colName,snapshot.size);

  if(snapshot.empty){
    dataTable.innerHTML = `<tr><td colspan="5">No data found</td></tr>`;
    return;
  }

  snapshot.forEach((docSnap)=>{
    const data = docSnap.data();
    const row = document.createElement("tr");

    if(type==="permissions"){
      row.innerHTML = `
        <td>${data.fullName || ""}</td>
        <td>${data.email || ""}</td>
        <td>${data.isApproved ? "Approved" : "Pending"}</td>
        <td>${!data.isApproved ? `<button class="approve-btn">Approve</button> <button class="deny-btn">Deny</button>` : ""}</td>
      `;

      if(!data.isApproved){
        const approveBtn = row.querySelector(".approve-btn");
        const denyBtn = row.querySelector(".deny-btn");

        approveBtn.addEventListener("click", async ()=>{
          await setDoc(doc(db,"users",docSnap.id), {...data,isApproved:true});
          loadData("permissions","üõ†Ô∏è Permissions","permissions");
        });

        denyBtn.addEventListener("click", async ()=>{
          await setDoc(doc(db,"users",docSnap.id), {...data,isApproved:false});
          loadData("permissions","üõ†Ô∏è Permissions","permissions");
        });
      }

    } else if(type==="contact"){
      row.innerHTML = `<td>${data.name||""}</td><td>${data.phone||"N/A"}</td><td>${data.email||"N/A"}</td>`;
    } else {
      row.innerHTML = `<td>${data.firstName||""} ${data.lastName||""}</td><td>${data.gender||"N/A"}</td><td>${data.age||"N/A"}</td><td>${data.phone||"N/A"}</td><td>${data.email||"N/A"}</td><td>${data.amount}</td><td>${data.status}</td>`;
    }

    row.addEventListener("click",()=>{ if(type!=="permissions") openModal(data); });
    dataTable.appendChild(row);
  });
}

function updateCount(colName,count){
  switch(colName){
    case "personal_nutrition_plan": nutritionCount.textContent=`ü•ó Personal Nutrition: ${count}`; break;
    case "personal_workout_plan": workoutCount.textContent=`üèãÔ∏è Personal Workouts: ${count}`; break;
    case "ultimate_personal_coaching": coachingCount.textContent=`üî•Ultimate Coaching: ${count}`; break;
    case "contacts": contactsCount.textContent=`üì© Messages: ${count}`; break;
  }
}

function openModal(data){
  modalBody.innerHTML="";
  const hidden=["userId","user","createdAt"];
  const prettify = key=>key.replace(/([A-Z])/g," $1").replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase());
  for(const [key,value] of Object.entries(data)){
    if(hidden.includes(key)) continue;
    const val = (typeof value==="object" && value!==null)? JSON.stringify(value,null,2) : value;
    modalBody.innerHTML += `<p><strong>${prettify(key)}:</strong> ${val}</p>`;
  }
  modal.style.display="flex";
}

window.closeModal=()=>{ modal.style.display="none"; }

document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    loadData(btn.dataset.col,btn.textContent,btn.dataset.type);
  });
});

// Initial load for all collections except permissions
loadData("personal_nutrition_plan","ü•ó Personal Nutrition Plan","normal");
loadData("personal_workout_plan","üèãÔ∏è Personal Workout Plan","normal");
loadData("ultimate_personal_coaching","üî• Ultimate Personal Coaching","normal");
loadData("contacts","üì© Messages","contact");

// Logout
window.logout=()=>{
  signOut(auth).then(()=>{
    alert("Logged out successfully");
    window.location.href="login.html";
  }).catch(err=>{ console.error(err); alert("Error logging out"); });
};
</script>
</body>
</html>
